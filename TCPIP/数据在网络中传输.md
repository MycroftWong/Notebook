# 一台局域网主机访问服务器的数据传输

在应用开发中，我们经常都在进行访问服务器。但是在网络中，数据时如何传输的呢？

对于这个问题，在没有学过TCP/IP之前，我只需要关心HTTP协议和一些API即可，框架和系统会帮我把这些事情完成；在学过TCP/IP的过程中，遇到很多问题，终于能够简单的理解这个过程。

前提：

- 主机A, B, C...
- 路由器R, A,B,C都是连接路由器R
- 结点N
- 服务器S

## 主机A与主机C通讯

在主机A中做的处理：

1. 应用层的数据交由传输层处理
2. 传输层加上传输层报文交由网络层处理
3. 网络层加上网络层的报文，同时发现目标IP和自己在同一局域网内
4. 根据地址转发表找到主机C的MAC地址，在数据链路层中添加以太网报文（目标MAC为C的MAC地址，源MAC地址为A的MAC地址-不保证正确，可能需要经过路由器R），传输数据

在主机C中做的处理：

1. 数据链路层收到数据，匹配MAC地址，正确，将数据解包，交由网络层处理
2. 网络层收到数据，匹配IP地址，正确，将数据解包，交由传输层处理
3. 传输层收到数据，解包，并保证数据可靠，交由应用层处理
4. 应用层处理

## 主机A与服务器S通讯

在主机A中做的处理：

1. 应用层的数据交由传输层处理
2. 传输层加上传输层报文交由网络层处理
3. 网络层加上网络层的报文（源IP地址为A的局域网的IP地址，目标IP地址为S的公网IP地址），同时发现目标IP和自己不在同一网段内
4. 根据地址转发表，找到路由器R的MAC地址，在数据链路层中添加以太网报文（目标MAC地址为路由器R的MAC地址，源MAC地址为A的MAC地址），传输数据

在路由器R中做的处理：

1. 数据链路层收到数据，匹配MAC地址，正确，将数据解包，交由网络层处理
2. 网络层收到数据，匹配IP地址，不正确，经过NAT处理，修改源IP地址为路由器R的IP地址，并经过一些处理，保存连接记录，交由数据链路层处理，同时根据路由转发表，得到传输路径R-N-S
3. 数据链路层得到数据之后，设置目标MAC地址为结点N的MAC地址，源MAC地址为路由器R的MAC地址，传输数据

在结点N中做的处理：

1. 数据链路层收到数据，匹配MAC地址，正确，将数据解包，交由网络层处理
2. 网络层收到数据，匹配IP地址，不正确，查询路由转发表，得到传输路径N-S，交由数据链路层处理
3. 数据链路层添加以太网报文，设置目标MAC地址为服务器S的MAC地址，源MAC地址为结点N的MAC地址，传输数据

在服务器S中做的处理：

1. 数据链路层收到数据，匹配MAC地址，正确，将数据解包，交由网络层处理
2. 网络层收到数据，匹配IP地址，正确，交由传输层处理
3. 传输层收到数据，匹配端口号，并保证数据可靠性，交由应用层处理
4. 应用层处理

---

服务器S中做的处理：

1. 应用层处理完成之后，交由传输层处理
2. 传输层添加报文后，交由网络层处理
3. 网络层添加报文后，交由数据链路层处理，并查询路由控制表，得到传输路径S-N-R
4. 数据链路层添加以太网报文，发送数据给结点N

结点N中做的处理：

...不再赘述

路由器R中做的处理：

1. 数据链路层收到数据，匹配MAC地址，正确，交由网络层处理
2. 网络层收到数据，匹配IP地址，正确，并根据之前保存的记录，知道这个数据是发送给主机A的，将目标MAC地址设置为A的MAC地址，并交由数据链路层处理
3. 数据链路层添加报文，设置目标MAC地址为A的MAC地址，源MAC地址为路由器R的MAC地址，并发送数据

主机A中做的处理：

1. 数据链路层收到数据，匹配MAC地址，正确，将数据解包，交由网络层处理
2. 网络层收到数据，匹配IP地址，正确，交由传输层处理
3. 传输层收到数据，匹配端口号，并保证数据可靠性，交由应用层处理
4. 应用层处理

## 参考

摘自百度知道：
>在局域网内，数据传输需要依靠MAC来识别对方地址。发生数据的时候，数据发送端计算机首先拿接收端的计算机IP与自己主机子网掩码相匹配，匹配后，发现跟自己是同一网段的，则使用MAC地址去寻找对方，如果不是同一网段的，则封装上对方的IP地址为目标地址，发现网关，由网关发现其他网络。不过到达了目标网络后，还是要根据对方MAC地址来寻找目标主机。 简单的说，局域网内传输用MAC，网间传输就要在MAC外面再加一层IP。

[关于在传输过程中MAC地址和IP地址，变与不变！](http://nanjingfm.blog.51cto.com/2121842/1179368/)